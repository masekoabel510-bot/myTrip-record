<style>
/* ===== Reset & Global ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
  width: 100%;
  overflow-x: hidden;
  font-family: 'Poppins', sans-serif;
}

/* ===== Background Setup ===== */
body {
  background: url('https://static.wixstatic.com/media/0a13f5_c67d95c70723474ebb15de67904d2e63~mv2.jpg')
    no-repeat center center fixed;
  background-size: cover;
  color: var(--text, #fff);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding: 2rem 1rem;
  gap: 1.5rem;
  perspective: 1500px;
  min-height: 100vh;
  position: relative;
}

/* ===== Scrollbar Hidden but Scroll Enabled ===== */
body {
  overflow-y: auto;
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none; /* IE/Edge */
}

body::-webkit-scrollbar {
  display: none; /* Chrome, Safari */
}

/* ===== Container ===== */
.container {
  max-width: 1200px;
  width: 100%;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

/* ===== Header ===== */
.header {
  text-align: center;
  color: white;
  margin-bottom: 20px;
  padding: 10px;
}

.header h1 {
  font-size: clamp(1.5rem, 5vw, 2.5rem);
  margin-bottom: 10px;
  text-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
  font-weight: 700;
}

.header p {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  opacity: 0.9;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
}

/* ===== Glass Effect Section ===== */
.global-filter {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 3px;
  padding: 25px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  margin-bottom: 20px;
}

.global-filter h3 {
  color: white;
  margin-bottom: 18px;
  font-size: clamp(1rem, 3vw, 1.3rem);
  font-weight: 600;
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.global-filter-controls {
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.global-filter-controls input[type="date"],
.global-filter-controls button {
  padding: 12px;
  border-radius: 3px;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.global-filter-controls input[type="date"] {
  border: 1px solid rgba(255,255,255,0.2);
  background: rgba(255,255,255,0.1);
  color: white;
  flex: 1 1 auto;
  min-width: 150px;
}

.global-filter-controls input[type="date"]:focus {
  outline: none;
  background: rgba(255,255,255,0.15);
  border-color: rgba(255,255,255,0.4);
}

.global-filter-controls button {
  border: 1px solid rgba(255,255,255,0.3);
  background: rgba(255,255,255,0.2);
  color: white;
  cursor: pointer;
}

.global-filter-controls button:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(0,0,0,0.2);
}

/* ===== Stats Grid ===== */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  padding: 20px 15px;
  border-radius: 3px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.15);
  text-align: center;
  transition: all 0.3s;
}

.stat-card:hover {
  background: rgba(255, 255, 255, 0.18);
  transform: translateY(-5px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.25);
}

.stat-card .icon {
  font-size: clamp(1.8rem, 5vw, 2.5rem);
  margin-bottom: 10px;
}

.stat-card .value {
  font-size: clamp(0.9rem, 2vw, 1rem);
  font-weight: bold;
  color: rgb(172, 187, 167);
  margin-bottom: 5px;
  word-break: break-word;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.stat-card .label {
  color: rgba(255, 255, 255, 0.85);
  font-size: clamp(0.75rem, 2vw, 0.9rem);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* ===== Cards ===== */
.card {
  background: rgba(255, 255, 255, 0.12);
  backdrop-filter: blur(25px);
  -webkit-backdrop-filter: blur(25px);
  border: 1px solid rgba(255, 255, 255, 0.25);
  border-radius: 3px;
  padding: 25px 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  margin-bottom: 20px;
}

.card h2 {
  color: white;
  margin-bottom: 20px;
  padding-bottom: 12px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.3);
  font-size: clamp(1.2rem, 4vw, 1.5rem);
  text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.card h3 {
  font-size: clamp(1rem, 3vw, 1.2rem);
  color: white;
}

/* ===== Forms ===== */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: 600;
  margin-bottom: 8px;
  color: white;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.form-group input,
.form-group textarea,
.form-group select {
  padding: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: white;
  border-radius: 3px;
  font-size: clamp(0.9rem, 3vw, 1rem);
  transition: all 0.3s;
  font-family: inherit;
  width: 100%;
}

.form-group input::placeholder,
.form-group textarea::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.4);
}

.form-group textarea {
  resize: vertical;
  min-height: 80px;
}

.form-group select {
  cursor: pointer;
}

.form-group select option {
  background: #2a5298;
  color: white;
}

/* ===== Buttons ===== */
.btn {
  padding: 14px 24px;
  border: none;
  border-radius: 3px;
  font-size: clamp(0.85rem, 2.5vw, 1rem);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  text-transform: uppercase;
  letter-spacing: 1px;
  width: 100%;
  max-width: 300px;
  touch-action: manipulation;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.btn-primary {
  background: rgba(102, 126, 234, 0.3);
  color: white;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.btn-primary:hover {
  background: rgba(102, 126, 234, 0.5);
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
  background: rgba(108, 117, 125, 0.3);
  color: white;
  margin-left: 0;
  margin-top: 10px;
  max-width: 200px;
}

.btn-secondary:hover {
  background: rgba(108, 117, 125, 0.5);
  transform: translateY(-2px);
}

.btn-small {
  padding: 10px 16px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  margin: 5px;
  width: auto;
  max-width: none;
}

.btn-edit {
  background: rgba(255, 193, 7, 0.3);
  color: white;
}

.btn-edit:hover {
  background: rgba(255, 193, 7, 0.5);
}

.btn-delete {
  background: rgba(220, 53, 69, 0.3);
  color: white;
}

.btn-delete:hover {
  background: rgba(220, 53, 69, 0.5);
}

.btn-fuel {
  background: rgba(40, 167, 69, 0.3);
  color: white;
}

.btn-fuel:hover {
  background: rgba(40, 167, 69, 0.5);
}

.btn-service {
  background: rgba(23, 162, 184, 0.3);
  color: white;
}

.btn-service:hover {
  background: rgba(23, 162, 184, 0.5);
}

.btn-incident {
  background: rgba(253, 126, 20, 0.3);
  color: white;
}

.btn-incident:hover {
  background: rgba(253, 126, 20, 0.5);
}

/* ===== Existing records section ===== */
.trips-list {
  display: grid;
  gap: 15px;
}

.trip-item, .fuel-item, .service-item, .checklist-item, .incident-item {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  padding: 18px;
  border-radius: 3px;
  border-left: 4px solid rgba(102, 126, 234, 0.6);
  transition: all 0.3s;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.fuel-item {
  border-left-color: rgba(40, 167, 69, 0.6);
}

.service-item {
  border-left-color: rgba(23, 162, 184, 0.6);
}

.checklist-item {
  border-left-color: rgba(255, 193, 7, 0.6);
}

.incident-item {
  border-left-color: rgba(220, 53, 69, 0.6);
}

.trip-item:hover, .fuel-item:hover, .service-item:hover, .checklist-item:hover, .incident-item:hover {
  background: rgba(255, 255, 255, 0.15);
  transform: translateY(-3px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
}

.trip-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
}

.trip-date, .fuel-date, .service-date, .checklist-date, .incident-date {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  font-weight: bold;
  flex: 1 1 auto;
  min-width: 150px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.trip-date {
  color: #a5b4fc;
}

.fuel-date {
  color: #86efac;
}

.service-date {
  color: #7dd3fc;
}

.checklist-date {
  color: #fde047;
}

.incident-date {
  color: #fca5a5;
}

.trip-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  justify-content: flex-end;
}

.trip-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(100%, 180px), 1fr));
  gap: 15px;
  margin-bottom: 10px;
}

.trip-detail {
  display: flex;
  align-items: center;
  gap: 10px;
}

.trip-detail .icon {
  font-size: clamp(1rem, 3vw, 1.2rem);
  flex-shrink: 0;
}

.trip-detail .content {
  flex: 1;
  min-width: 0;
}

.trip-detail .content .label {
  font-size: clamp(0.7rem, 2vw, 0.8rem);
  color: rgba(255, 255, 255, 0.7);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.trip-detail .content .value {
  font-weight: 600;
  color: white;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  word-break: break-word;
}

.trip-notes {
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  padding: 15px;
  border-radius: 3px;
  margin-top: 10px;
  font-style: italic;
  color: rgba(255, 255, 255, 0.9);
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  word-break: break-word;
}

.no-trips {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.6);
}

.no-trips .icon {
  font-size: clamp(3rem, 10vw, 5rem);
  margin-bottom: 20px;
  opacity: 0.3;
}

.no-trips h3 {
  font-size: clamp(1.2rem, 4vw, 1.5rem);
  margin-bottom: 10px;
  color: rgba(255, 255, 255, 0.8);
}

/* ===== Filter Bar ===== */
.filter-bar {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  align-items: stretch;
}

.filter-bar input,
.filter-bar select {
  padding: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  color: white;
  border-radius: 3px;
  font-size: clamp(0.85rem, 2.5vw, 0.9rem);
  flex: 1 1 auto;
  min-width: 120px;
  transition: all 0.3s;
}

.filter-bar input::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

.filter-bar input:focus,
.filter-bar select:focus {
  outline: none;
  background: rgba(255, 255, 255, 0.15);
  border-color: rgba(255, 255, 255, 0.4);
}

.filter-bar select option {
  background: #2a5298;
  color: white;
}

.export-btn {
  background: rgba(40, 167, 69, 0.3);
  color: white;
  margin-left: 0;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.export-btn:hover {
  background: rgba(40, 167, 69, 0.5);
  transform: translateY(-2px);
}

.distance-badge {
  display: inline-block;
  background: rgba(102, 126, 234, 0.3);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  color: white;
  padding: 10px 18px;
  border-radius: 3px;
  font-weight: bold;
  margin-top: 12px;
  font-size: clamp(0.85rem, 2.5vw, 0.95rem);
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

/* ===== Service Alerts ===== */
.service-alert {
  background: rgba(255, 243, 205, 0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 193, 7, 0.3);
  padding: 18px;
  border-radius: 3px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
}

.service-alert.urgent {
  background: rgba(248, 215, 218, 0.15);
  border-color: rgba(220, 53, 69, 0.4);
}

.service-alert .icon {
  font-size: clamp(1.5rem, 5vw, 2rem);
  flex-shrink: 0;
}

.service-alert .content {
  flex: 1;
  min-width: 200px;
}

.service-alert .title {
  font-weight: bold;
  font-size: clamp(0.95rem, 3vw, 1.1rem);
  margin-bottom: 5px;
  color: white;
}

.service-alert .content div {
  color: rgba(255, 255, 255, 0.9);
}

/* ===== Checklist ===== */
.checklist-grid {
  display: grid;
  gap: 10px;
}

.checklist-item-line {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 14px;
  background: rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 3px;
  transition: all 0.3s;
}

.checklist-item-line:hover {
  background: rgba(255, 255, 255, 0.12);
}

.checklist-item-line input[type="checkbox"] {
  width: 24px;
  height: 24px;
  cursor: pointer;
  flex-shrink: 0;
  accent-color: rgba(102, 126, 234, 0.8);
}

.checklist-item-line label {
  flex: 1;
  cursor: pointer;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  color: white;
}

.checklist-item-line.checked {
  opacity: 0.6;
}

.checklist-item-line.checked label {
  text-decoration: line-through;
}

.status-badge {
  padding: 6px 14px;
  border-radius: 3px;
  font-size: clamp(0.75rem, 2vw, 0.85rem);
  font-weight: bold;
  white-space: nowrap;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.status-ok {
  background: rgba(212, 237, 218, 0.3);
  color: #86efac;
}

.status-issue {
  background: rgba(248, 215, 218, 0.3);
  color: #fca5a5;
}

/* ===== Image Upload ===== */
.image-upload-area {
  border: 2px dashed rgba(255, 255, 255, 0.3);
  border-radius: 3px;
  padding: 30px 15px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
}

.image-upload-area:hover {
  border-color: rgba(102, 126, 234, 0.6);
  background: rgba(102, 126, 234, 0.1);
}

.image-upload-area.has-image {
  border-color: rgba(40, 167, 69, 0.6);
  background: rgba(40, 167, 69, 0.1);
}

.image-upload-area div {
  color: white;
}

.image-upload-area small {
  color: rgba(255, 255, 255, 0.7);
}

.image-preview {
  max-width: 100%;
  max-height: 300px;
  border-radius: 3px;
  margin-top: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.receipt-thumbnail {
  max-width: 120px;
  max-height: 120px;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  margin: 5px;
  object-fit: cover;
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.receipt-thumbnail:hover {
  transform: scale(1.08);
  box-shadow: 0 6px 25px rgba(0,0,0,0.3);
}

.images-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 10px;
  justify-content: center;
}

/* ===== Modal ===== */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.85);
  backdrop-filter: blur(10px);
  animation: fadeIn 0.3s;
  overflow: auto;
}

.modal-content-image {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  max-width: 90%;
  max-height: 90vh;
  text-align: center;
}

.modal-image {
  max-width: 100%;
  max-height: 85vh;
  border-radius: 3px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.6);
}

.close-modal {
  position: fixed;
  top: 20px;
  right: 30px;
  color: #fff;
  font-size: 40px;
  font-weight: bold;
  cursor: pointer;
  z-index: 1001;
  padding: 10px;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 3px;
  width: 55px;
  height: 55px;
  display: flex;
  align-items: center;
  justify-content: center;
  line-height: 1;
  transition: all 0.3s;
}

.close-modal:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.1);
}

/* ===== Confirm Dialog ===== */
.confirm-dialog {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  backdrop-filter: blur(10px);
  animation: fadeIn 0.2s;
}

.confirm-content {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0.15);
  backdrop-filter: blur(30px);
  -webkit-backdrop-filter: blur(30px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 3px;
  padding: 35px;
  max-width: 420px;
  width: 90%;
  box-shadow: 0 10px 50px rgba(0,0,0,0.4);
  text-align: center;
}

.confirm-content h3 {
  color: white;
  margin-bottom: 18px;
  font-size: 1.4rem;
  text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.confirm-content p {
  color: rgba(255, 255, 255, 0.85);
  margin-bottom: 28px;
  font-size: 1.05rem;
  line-height: 1.6;
}

.confirm-buttons {
  display: flex;
  gap: 12px;
  justify-content: center;
  flex-wrap: wrap;
}

.confirm-buttons button {
  padding: 12px 28px;
  border: none;
  border-radius: 3px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s;
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.confirm-yes {
  background: rgba(220, 53, 69, 0.3);
  color: white;
}

.confirm-yes:hover {
  background: rgba(220, 53, 69, 0.5);
  transform: translateY(-2px);
}

.confirm-no {
  background: rgba(108, 117, 125, 0.3);
  color: white;
}

.confirm-no:hover {
  background: rgba(108, 117, 125, 0.5);
  transform: translateY(-2px);
}

/* ===== Tabs ===== */
.tab-nav {
  display: flex;
  gap: 8px;
  margin-bottom: 25px;
  border-bottom: 2px solid rgba(255, 255, 255, 0.15);
  flex-wrap: nowrap;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  padding-bottom: 5px;
}

.tab-btn {
  padding: 14px 18px;
  background: rgba(255, 255, 255, 0.05);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  cursor: pointer;
  font-size: clamp(0.8rem, 2.5vw, 0.95rem);
  font-weight: 600;
  color: rgba(255, 255, 255, 0.7);
  transition: all 0.3s;
  border-radius: 3px;
  white-space: nowrap;
  flex-shrink: 0;
  touch-action: manipulation;
  width: 19%;
 
}

.tab-btn.active {
  background: rgba(102, 126, 234, 0.2);
  color: white;
  border-color: rgba(102, 126, 234, 0.4);
  box-shadow: 0 -2px 10px rgba(102, 126, 234, 0.3);
}

.tab-btn:hover {
  background: rgba(255, 255, 255, 0.1);
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(40, 167, 69, 0.25);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white;
  padding: 16px 24px;
  border-radius: 3px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  z-index: 9999;
  animation: slideIn 0.3s, slideOut 0.3s 2.7s;
  font-size: clamp(0.9rem, 2.5vw, 1rem);
  max-width: 320px;
}

.toast.warning {
  background: rgba(255, 193, 7, 0.25);
}

.toast.error {
  background: rgba(220, 53, 69, 0.25);
}

/* ===== Animations ===== */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}

@keyframes backgroundShift {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.9; transform: scale(1.05); }
}

/* ===== PDF Export Styles ===== */
#pdfExportContent {
  display: none;
}

.pdf-page {
  background: white;
  padding: 40px;
  max-width: 1000px;
  margin: 0 auto;
  font-family: Arial, sans-serif;
  color: #000 !important;
}

.pdf-title {
  text-align: center;
  font-size: 28px;
  font-weight: bold;
  margin-bottom: 30px;
  color: #333 !important;
  border-bottom: 4px solid #667eea;
  padding-bottom: 15px;
}

.pdf-section {
  margin-bottom: 40px;
  page-break-inside: avoid;
}

.pdf-section-title {
  font-size: 22px;
  font-weight: bold;
  margin-bottom: 20px;
  color: #667eea !important;
  border-left: 5px solid #667eea;
  padding-left: 15px;
  background: #f0f4ff;
  padding: 12px 15px;
  border-radius: 3px;
}

.pdf-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 25px;
  font-size: 11px;
}

.pdf-table th {
  background: #667eea;
  color: white !important;
  padding: 12px 10px;
  text-align: left;
  font-weight: bold;
  border: 1px solid #ccc;
}

.pdf-table td {
  padding: 10px;
  border: 1px solid #ccc;
  vertical-align: top;
  color: #333 !important;
}

.pdf-table tr:nth-child(even) {
  background: #f9f9f9;
}

.pdf-gallery {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 15px;
  margin: 20px 0;
  page-break-inside: avoid;
}

.pdf-gallery img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border: 2px solid #ccc;
  border-radius: 3px;
}

.pdf-trip-detail {
  margin-bottom: 30px;
  padding: 20px;
  border: 2px solid #e0e0e0;
  border-radius: 10px;
  page-break-inside: avoid;
  background: #fafafa;
}

.pdf-trip-header {
  font-size: 16px;
  font-weight: bold;
  color: #667eea !important;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 2px solid #667eea;
}

.pdf-trip-info {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  font-size: 12px;
  margin-bottom: 15px;
}

.pdf-trip-info-item {
  padding: 8px;
  color: #333 !important;
}

.pdf-trip-info-label {
  font-weight: bold;
  color: #555 !important;
  display: inline-block;
  min-width: 90px;
}

/* ===== PRINT MEDIA ===== */
@media print {
  @page { 
    margin: 0.75in; 
    size: A4 landscape; 
  }
  
  body {
    background: white !important;
    padding: 0 !important;
  }
  
  body::before {
    display: none !important;
  }
  
  #pdfExportContent {
    display: block !important;
  }
  
  .container, .header, .card, .modal, .global-filter, .stats-grid, #serviceAlerts {
    display: none !important;
  }
  
  .pdf-page {
    background: white !important;
    color: #000 !important;
    padding: 0 !important;
    margin: 0 auto !important;
    max-width: 100% !important;
  }
  
  .pdf-page * {
    color: #333 !important;
  }
  
  .pdf-title {
    color: #000 !important;
  }
  
  .pdf-section-title {
    color: #667eea !important;
  }
  
  .pdf-table {
    width: 100% !important;
  }
  
  .pdf-table th {
    color: white !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }
  
  .pdf-table td {
    color: #000 !important;
  }
  
  .pdf-trip-header {
    color: #667eea !important;
  }
  
  .pdf-trip-info {
    width: 100% !important;
  }
  
  .pdf-trip-info-item {
    color: #000 !important;
  }
  
  .pdf-trip-info-label {
    color: #555 !important;
  }
  
  .pdf-trip-detail {
    width: 100% !important;
    box-sizing: border-box !important;
  }
}

/* ===== MOBILE RESPONSIVE - GRAY BACKGROUND ===== */
@media (max-width: 768px) {
  body {
    background: linear-gradient(135deg, #5a6268 0%, #6c757d 100%) !important;
    background-attachment: fixed !important;
    padding: 10px;
  }
  
  body::before {
    display: none !important;
  }
  
  .header { 
    margin-bottom: 15px;
    background: rgba(255, 255, 255, 0.15);
    padding: 20px;
    border-radius: 3px;
  }
  
  .global-filter { 
    padding: 18px;
    background: rgba(255, 255, 255, 0.15);
  }
  
  .global-filter-controls { 
    flex-direction: column; 
  }
  
  .global-filter-controls input[type="date"],
  .global-filter-controls button { 
    width: 100%; 
  }
  
  .stats-grid { 
    grid-template-columns: repeat(2, 1fr); 
    gap: 12px; 
  }
  
  .stat-card { 
    padding: 18px 12px;
    background: rgba(255, 255, 255, 0.15);
  }
  
  .card { 
    padding: 18px 12px;
    background: rgba(255, 255, 255, 0.15);
  }
  
  .form-grid { 
    grid-template-columns: 1fr; 
    gap: 12px; 
  }
  
  .trip-details { 
    grid-template-columns: 1fr; 
  }
  
  .trip-header { 
    flex-direction: column; 
    align-items: stretch; 
  }
  
  .trip-actions { 
    justify-content: stretch; 
    width: 100%; 
  }
  
  .trip-actions .btn { 
    flex: 1; 
  }
  
  .filter-bar { 
    flex-direction: column; 
    gap: 10px; 
  }
  
  .filter-bar input, 
  .filter-bar select, 
  .filter-bar button { 
    width: 100%; 
  }
  
  .btn { 
    max-width: none; 
    width: 100%; 
  }
  
  .btn-secondary { 
    max-width: none; 
  }
  
  .btn-small { 
    font-size: 0.8rem; 
    padding: 10px 12px; 
  }
  
  .tab-nav { 
    gap: 5px; 
  }
  
  .tab-btn { 
    padding: 12px 14px; 
    font-size: 0.85rem; 
  }
  
  .trip-item, 
  .fuel-item, 
  .service-item, 
  .checklist-item, 
  .incident-item { 
    padding: 15px;
    background: rgba(255, 255, 255, 0.12);
  }
  
  .receipt-thumbnail { 
    max-width: 100px; 
    max-height: 100px; 
  }
  
  .service-alert { 
    padding: 15px; 
    gap: 12px; 
  }
  
  .no-trips { 
    padding: 35px 18px; 
  }
  
  .confirm-content { 
    width: 95%; 
    padding: 25px; 
  }
  
  .close-modal { 
    font-size: 32px; 
    right: 18px; 
    top: 18px; 
    width: 50px; 
    height: 50px; 
  }
  
  .toast { 
    right: 10px; 
    bottom: 10px; 
    max-width: calc(100% - 20px); 
  }
}

@media (max-width: 480px) {
  body {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
    background-attachment: fixed !important;
  }
  
  .stats-grid { 
    grid-template-columns: 1fr; 
  }
  
  .btn-small { 
    font-size: 0.75rem; 
    padding: 8px 10px; 
    margin: 3px; 
  }
  
  .receipt-thumbnail { 
    max-width: 85px; 
    max-height: 85px; 
  }
  
  .confirm-content { 
    padding: 22px 18px; 
  }
}

@media (min-width: 769px) {
  body { 
    padding: 20px; 
  }
  
  .btn { 
    width: auto; 
  }
}

/* ===== User Selection ===== */
.btn, .tab-btn {
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}

/* ===== Touch Targets ===== */
@media (hover: none) and (pointer: coarse) {
  .btn, .tab-btn, .checklist-item-line { 
    min-height: 44px; 
  }
  
  .trip-actions .btn { 
    min-height: 40px; 
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1><img src="https://images.vexels.com/media/users/3/127711/isolated/preview/384e0b3361d99d9c370b4037115324b9-flat-vintage-car-icon.png" 
     alt="Car Icon" 
     width="50">
Driver Trip Tracker</h1>
    <p>All data saved in this app will exist forever in your current device only until you delete it</p>
  </div>



  <div class="global-filter">
  <h3><img src="https://i2.wp.com/cdn0.iconfinder.com/data/icons/small-n-flat/24/678120-calendar-clock-512.png" 
     alt="Car Icon" 
     width="30"> Filter All Data by Date Range</h3>
    <div class="global-filter-controls">
      <input type="date" id="globalStartDate">
      <input type="date" id="globalEndDate">
      <button onclick="applyGlobalFilter()">Apply Filter</button>
      <button onclick="clearGlobalFilter()" style="background: rgba(108, 117, 125, 0.3);">Clear Filter</button>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="icon"></div>
      <div class="value" id="totalTrips">0</div>
      <div class="label">Total Trips</div>
    </div>
    <div class="stat-card">
      <div class="icon"></div>
      <div class="value" id="totalDistance">0 km</div>
      <div class="label">Total Distance</div>
    </div>
    <div class="stat-card">
      <div class="icon"></div>
      <div class="value" id="totalFuelLiters">0 L</div>
      <div class="label">Total Fuel</div>
    </div>
    <div class="stat-card">
      <div class="icon"></div>
      <div class="value" id="totalFuelCost">R0</div>
      <div class="label">Fuel Cost</div>
    </div>
  </div>

  <div id="serviceAlerts"></div>

  <div class="card">
    <div class="tab-nav">
      <button class="tab-btn active" onclick="switchTab('trips')">
  <img src="https://www.pngkey.com/png/full/60-601527_top-car-view-png-free-icons-and-backgrounds.png" 
       alt="Car Icon" 
       class="icon">
  Trips
</button>
<style>.tab-btn .icon {
  width: 50px;   /* adjust size here */
  height: 25px;
  margin-right: 6px;
  vertical-align: middle;

}
</style>
      <button class="tab-btn active" onclick="switchTab('fuel')">
  <img src="https://cdn-icons-png.flaticon.com/512/4514/4514864.png" 
       alt="Car Icon" 
       class="icon1">
  Fuel log
</button>
<style>.tab-btn .icon1 {
  width: 35px;   /* adjust size here */
  height: 40px;
  margin-right: 6px;
  vertical-align: middle;

}
</style>
       <button class="tab-btn active" onclick="switchTab('service')">
  <img src="https://png.pngtree.com/png-vector/20220428/ourmid/pngtree-vector-illustration-of-a-semiflat-colored-car-repair-vector-png-image_30151204.png" 
       alt="Car Icon" 
       class="icon2">
  Service
</button>
<style>.tab-btn .icon2 {
  width: 50px;   /* adjust size here */
  height: 40px;
  margin-right: 6px;
  vertical-align: middle;

}
</style>

       <button class="tab-btn active" onclick="switchTab('checklist')">
  <img src="https://static.vecteezy.com/system/resources/thumbnails/026/593/215/small/3d-white-clipboard-icon-task-management-todo-check-list-on-turquose-plane-background-work-project-plan-concept-isolated-transparent-posting-plan-productivity-checklist-png.png" 
       alt="Car Icon" 
       class="icon2">
  Checklist
</button>
<style>.tab-btn .icon2 {
  width: 50px;   /* adjust size here */
  height: 40px;
  margin-right: 6px;
  vertical-align: middle;

}
</style>
         <button class="tab-btn active" onclick="switchTab('incidents')">
  <img src="https://cdn-icons-png.flaticon.com/256/7910/7910777.png" 
       alt="Car Icon" 
       class="icon4">
  Incident
</button>
<style>.tab-btn .icon4 {
  width: 50px;   /* adjust size here */
  height: 50px;
  margin-right: 6px;
  vertical-align: middle;

}
</style>
    </div>

    <div id="tripsTab" class="tab-content active">
      <h2> Add New Trip</h2>
      <form id="tripForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="tripDate">Date *</label>
            <input type="date" id="tripDate" required>
          </div>
          <div class="form-group">
            <label for="tripTime">Time</label>
            <input type="time" id="tripTime">
          </div>
          <div class="form-group">
            <label for="driverName">Driver's Name *</label>
            <input type="text" id="driverName" placeholder="e.g., John Smith" required>
          </div>
          <div class="form-group">
            <label for="vehicleReg">Vehicle Registration *</label>
            <input type="text" id="vehicleReg" placeholder="e.g., ABC-123-GP" required>
          </div>
          <div class="form-group">
            <label for="startLocation">Start Location *</label>
            <input type="text" id="startLocation" placeholder="e.g., Johannesburg" required>
          </div>
          <div class="form-group">
            <label for="endLocation">End Location *</label>
            <input type="text" id="endLocation" placeholder="e.g., Pretoria" required>
          </div>
          <div class="form-group">
            <label for="startKm">Start KM *</label>
            <input type="number" id="startKm" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="endKm">End KM *</label>
            <input type="number" id="endKm" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="reference">Reference</label>
            <input type="text" id="reference" placeholder="e.g., PO-12345">
          </div>
        </div>

        <div class="form-group">
          <label>üì∑ Destination Photos (Optional)</label>
          <div class="image-upload-area" id="tripImageUploadArea" onclick="document.getElementById('tripImages').click()">
            <input type="file" id="tripImages" accept="image/*" capture="environment" multiple style="display: none;">
            <div id="tripUploadText">
              üì∑ Click to take photos at destination
              <br><small>You can select multiple photos</small>
            </div>
          </div>
          <div id="tripImagesPreview" class="images-grid"></div>
        </div>

        <div class="form-group"> 
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Any additional details about the trip..."></textarea>
        </div><br>
        <button type="submit" class="btn btn-primary">
          <span id="submitBtnText">Add Trip</span>
        </button>
        <button type="button" class="btn btn-secondary" id="cancelBtn" style="display: none;">Cancel</button>
      </form>

      <h2 style="margin-top: 40px;">üìã Trip History</h2>
      <div class="filter-bar">
        <input type="text" id="searchInput" placeholder="üîç Search trips...">
        <input type="text" id="filterVehicle" placeholder="üöó Vehicle Reg">
        <input type="text" id="filterDriver" placeholder="üë§ Driver Name">
        <input type="text" id="filterReference" placeholder="üìã Reference">
        <button class="btn btn-small export-btn" onclick="exportToPDF()">üì• Download PDF</button>
        <button class="btn btn-small btn-delete" onclick="showConfirmDialog('clearAllTrips')">üóëÔ∏è Clear All</button>
      </div>
      <div class="trips-list" id="tripsList"></div>
    </div>

    <div id="fuelTab" class="tab-content">
      <h2>‚õΩ Add Fuel Refill</h2>
      <form id="fuelForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="fuelDate">Date *</label>
            <input type="date" id="fuelDate" required>
          </div>
          <div class="form-group">
            <label for="fuelTime">Time</label>
            <input type="time" id="fuelTime">
          </div>
          <div class="form-group">
            <label for="fuelDriverName">Driver's Name *</label>
            <input type="text" id="fuelDriverName" placeholder="e.g., John Smith" required>
          </div>
          <div class="form-group">
            <label for="fuelVehicleReg">Vehicle Registration *</label>
            <input type="text" id="fuelVehicleReg" placeholder="e.g., ABC-123-GP" required>
          </div>
          <div class="form-group">
            <label for="fuelKmReading">KM Reading *</label>
            <input type="number" id="fuelKmReading" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="fuelLiters">Fuel Amount (Liters) *</label>
            <input type="number" id="fuelLiters" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="fuelCost">Total Cost (R) *</label>
            <input type="number" id="fuelCost" placeholder="0.00" step="0.01" required>
          </div>
          <div class="form-group">
            <label for="fuelStation">Fuel Station</label>
            <input type="text" id="fuelStation" placeholder="e.g., Shell, Engen">
          </div>
        </div>
        
        <div class="form-group">
          <label>Receipt Photo</label>
          <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('receiptImage').click()">
            <input type="file" id="receiptImage" accept="image/*" capture="environment" style="display: none;">
            <div id="uploadText">
              üì∑ Click to take photo or upload receipt
              <br><small>Supports: JPG, PNG, HEIC</small>
            </div>
            <img id="imagePreview" class="image-preview" style="display: none;">
          </div>
        </div>

        <div class="form-group">
          <label for="fuelNotes">Notes</label>
          <textarea id="fuelNotes" placeholder="Any additional details..."></textarea>
        </div>
        <br>
        <button type="submit" class="btn btn-fuel">
          <span id="fuelSubmitBtnText">Add Fuel Entry</span>
        </button>
        <button type="button" class="btn btn-secondary" id="fuelCancelBtn" style="display: none;">Cancel</button>
      </form>

      <h2 style="margin-top: 40px;">‚õΩ Fuel History</h2>
      <div class="filter-bar">
        <input type="text" id="fuelSearchInput" placeholder="üîç Search fuel entries...">
        <input type="text" id="fuelFilterVehicle" placeholder="üöó Vehicle Reg">
        <input type="text" id="fuelFilterDriver" placeholder="üë§ Driver Name">
        <button class="btn btn-small export-btn" onclick="exportToPDF()">üì• Download PDF</button>
        <button class="btn btn-small btn-delete" onclick="showConfirmDialog('clearAllFuel')">üóëÔ∏è Clear All</button>
      </div>
      <div class="trips-list" id="fuelList"></div>
    </div>

    <div id="serviceTab" class="tab-content">
      <h2>üîß Set Service Reminder</h2>
      <form id="serviceForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="serviceVehicleReg">Vehicle Registration *</label>
            <input type="text" id="serviceVehicleReg" placeholder="e.g., ABC-123-GP" required>
          </div>
          <div class="form-group">
            <label for="currentServiceKm">Current KM Reading *</label>
            <input type="number" id="currentServiceKm" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="nextServiceKm">Next Service KM *</label>
            <input type="number" id="nextServiceKm" placeholder="0" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="serviceType">Service Type *</label>
            <select id="serviceType" required>
              <option value="Regular Service">Regular Service</option>
              <option value="Major Service">Major Service</option>
              <option value="Oil Change">Oil Change</option>
              <option value="Tire Change">Tire Change</option>
              <option value="Brake Service">Brake Service</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label for="serviceNotes">Notes</label>
          <textarea id="serviceNotes" placeholder="Service details..."></textarea>
        </div>
        <br>
        <button type="submit" class="btn btn-service">
          <span id="serviceSubmitBtnText">Set Reminder</span>
        </button>
        <button type="button" class="btn btn-secondary" id="serviceCancelBtn" style="display: none;">Cancel</button>
      </form>

      <h2 style="margin-top: 40px;">üîß Service Reminders</h2>
      <div class="trips-list" id="serviceList"></div>
    </div>

    <div id="checklistTab" class="tab-content">
      <h2>‚úÖ Vehicle Inspection Checklist</h2>
      <form id="checklistForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="checklistDate">Date *</label>
            <input type="date" id="checklistDate" required>
          </div>
          <div class="form-group">
            <label for="checklistDriverName">Driver's Name *</label>
            <input type="text" id="checklistDriverName" placeholder="e.g., John Smith" required>
          </div>
          <div class="form-group">
            <label for="checklistVehicleReg">Vehicle Registration *</label>
            <input type="text" id="checklistVehicleReg" placeholder="e.g., ABC-123-GP" required>
          </div>
          <div class="form-group">
            <label for="checklistKmReading">KM Reading *</label>
            <input type="number" id="checklistKmReading" placeholder="0" step="0.1" required>
          </div>
        </div>

        <h3 style="margin: 20px 0 15px 0;">Checklist Items</h3>
        <div class="checklist-grid">
          <div class="checklist-item-line">
            <input type="checkbox" id="check_tires" checked>
            <label for="check_tires">üõû Tires (Pressure & Condition)</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_oil" checked>
            <label for="check_oil">üõ¢Ô∏è Engine Oil Level</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_water" checked>
            <label for="check_water">üíß Coolant/Water Level</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_brakes" checked>
            <label for="check_brakes">üõë Brakes</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_lights" checked>
            <label for="check_lights">üí° Lights (All)</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_wipers" checked>
            <label for="check_wipers">üåßÔ∏è Windscreen Wipers</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_battery" checked>
            <label for="check_battery">üîã Battery</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_mirrors" checked>
            <label for="check_mirrors">ü™û Mirrors</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_belts" checked>
            <label for="check_belts">üîó Drive Belts</label>
          </div>
          <div class="checklist-item-line">
            <input type="checkbox" id="check_fuel" checked>
            <label for="check_fuel">‚õΩ Fuel Level</label>
          </div>
        </div>

        <div class="form-group" style="margin-top: 20px;">
          <label for="checklistNotes">Additional Notes / Issues Found</label>
          <textarea id="checklistNotes" placeholder="Note any issues or concerns..."></textarea>
        </div>
<br>
        <button type="submit" class="btn btn-primary">
          <span id="checklistSubmitBtnText">Save Checklist</span>
        </button>
        <button type="button" class="btn btn-secondary" id="checklistCancelBtn" style="display: none;">Cancel</button>
      </form>

      <h2 style="margin-top: 40px;">‚úÖ Checklist History</h2>
      <div class="filter-bar">
        <input type="text" id="checklistSearchInput" placeholder="üîç Search checklists...">
        <input type="text" id="checklistFilterDriver" placeholder="üë§ Driver Name">
        <input type="text" id="checklistFilterVehicle" placeholder="üöó Vehicle Reg">
        <button class="btn btn-small export-btn" onclick="exportToPDF()">üì• Download PDF</button>
        <button class="btn btn-small btn-delete" onclick="showConfirmDialog('clearAllChecklists')">üóëÔ∏è Clear All</button>
      </div>
      <div class="trips-list" id="checklistList"></div>
    </div>

    <div id="incidentsTab" class="tab-content">
      <h2>‚ö†Ô∏è Report Incident</h2>
      <form id="incidentForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="incidentDate">Date *</label>
            <input type="date" id="incidentDate" required>
          </div>
          <div class="form-group">
            <label for="incidentTime">Time</label>
            <input type="time" id="incidentTime">
          </div>
          <div class="form-group">
            <label for="incidentDriverName">Driver's Name *</label>
            <input type="text" id="incidentDriverName" placeholder="e.g., John Smith" required>
          </div>
          <div class="form-group">
            <label for="incidentVehicleReg">Vehicle Registration *</label>
            <input type="text" id="incidentVehicleReg" placeholder="e.g., ABC-123-GP" required>
          </div>
          <div class="form-group">
            <label for="incidentLocation">Location *</label>
            <input type="text" id="incidentLocation" placeholder="Where did it happen?" required>
          </div>
          <div class="form-group">
            <label for="incidentType">Incident Type *</label>
            <select id="incidentType" required>
              <option value="Scratch">Scratch</option>
              <option value="Dent">Dent</option>
              <option value="Collision">Collision</option>
              <option value="Flat Tire">Flat Tire</option>
              <option value="Broken Glass">Broken Glass</option>
              <option value="Paint Damage">Paint Damage</option>
              <option value="Mechanical Issue">Mechanical Issue</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="incidentDescription">Description *</label>
          <textarea id="incidentDescription" placeholder="Describe what happened..." required></textarea>
        </div>

        <div class="form-group">
          <label>Photos of Damage</label>
          <div class="image-upload-area" id="incidentImageUploadArea" onclick="document.getElementById('incidentImages').click()">
            <input type="file" id="incidentImages" accept="image/*" capture="environment" multiple style="display: none;">
            <div id="incidentUploadText">
              üì∑ Click to take photos or upload images
              <br><small>You can select multiple photos</small>
            </div>
          </div>
          <div id="incidentImagesPreview" class="images-grid"></div>
        </div>

        <button type="submit" class="btn btn-incident">
          <span id="incidentSubmitBtnText">Report Incident</span>
        </button>
        <button type="button" class="btn btn-secondary" id="incidentCancelBtn" style="display: none;">Cancel</button>
      </form>

      <h2 style="margin-top: 40px;">‚ö†Ô∏è Incident Reports</h2>
      <div class="filter-bar">
        <input type="text" id="incidentSearchInput" placeholder="üîç Search incidents...">
        <input type="text" id="incidentFilterDriver" placeholder="üë§ Driver Name">
        <input type="text" id="incidentFilterVehicle" placeholder="üöó Vehicle Reg">
        <select id="incidentFilterType">
          <option value="">All Types</option>
          <option value="Scratch">Scratch</option>
          <option value="Dent">Dent</option>
          <option value="Collision">Collision</option>
          <option value="Flat Tire">Flat Tire</option>
          <option value="Broken Glass">Broken Glass</option>
          <option value="Paint Damage">Paint Damage</option>
          <option value="Mechanical Issue">Mechanical Issue</option>
          <option value="Other">Other</option>
        </select>
        <button class="btn btn-small export-btn" onclick="exportToPDF()">üì• Download PDF</button>
        <button class="btn btn-small btn-delete" onclick="showConfirmDialog('clearAllIncidents')">üóëÔ∏è Clear All</button>
      </div>
      <div class="trips-list" id="incidentList"></div>
    </div>

  </div>
</div>

<div id="pdfExportContent"></div>

<div id="imageModal" class="modal">
  <span class="close-modal" onclick="closeImageModal()">&times;</span>
  <div class="modal-content-image">
    <img id="modalImage" class="modal-image">
  </div>
</div>

<div id="confirmDialog" class="confirm-dialog">
  <div class="confirm-content">
    <h3 id="confirmTitle">Confirm Action</h3>
    <p id="confirmMessage">Are you sure?</p>
    <div class="confirm-buttons">
      <button class="confirm-yes" onclick="confirmAction()">Yes, Delete</button>
      <button class="confirm-no" onclick="closeConfirmDialog()">Cancel</button>
    </div>
  </div>
</div>

<script>
let trips = JSON.parse(localStorage.getItem('driverTrips')) || [];
let fuelEntries = JSON.parse(localStorage.getItem('fuelEntries')) || [];
let serviceReminders = JSON.parse(localStorage.getItem('serviceReminders')) || [];
let checklists = JSON.parse(localStorage.getItem('vehicleChecklists')) || [];
let incidents = JSON.parse(localStorage.getItem('incidents')) || [];
let editingTripId = null;
let editingFuelId = null;
let editingServiceId = null;
let editingChecklistId = null;
let editingIncidentId = null;
let currentReceiptImage = null;
let currentIncidentImages = [];
let currentTripImages = [];
let pendingConfirmAction = null;
let globalStartDate = null;
let globalEndDate = null;

document.getElementById('tripDate').valueAsDate = new Date();
document.getElementById('fuelDate').valueAsDate = new Date();
document.getElementById('checklistDate').valueAsDate = new Date();
document.getElementById('incidentDate').valueAsDate = new Date();

function autoFillTripForm() {
  if (trips.length > 0 && !editingTripId) {
    const sortedTrips = [...trips].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastTrip = sortedTrips[0];
    document.getElementById('startKm').value = lastTrip.endKm;
    document.getElementById('driverName').value = lastTrip.driverName;
    document.getElementById('vehicleReg').value = lastTrip.vehicleReg;
  }
}

function autoFillFuelForm() {
  if (fuelEntries.length > 0 && !editingFuelId) {
    const sortedFuel = [...fuelEntries].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastFuel = sortedFuel[0];
    document.getElementById('fuelDriverName').value = lastFuel.driverName;
    document.getElementById('fuelVehicleReg').value = lastFuel.vehicleReg;
    document.getElementById('fuelStation').value = lastFuel.station || '';
  }
}

function autoFillChecklistForm() {
  if (checklists.length > 0 && !editingChecklistId) {
    const sortedChecklists = [...checklists].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastChecklist = sortedChecklists[0];
    document.getElementById('checklistDriverName').value = lastChecklist.driverName;
    document.getElementById('checklistVehicleReg').value = lastChecklist.vehicleReg;
  }
}

function autoFillIncidentForm() {
  if (incidents.length > 0 && !editingIncidentId) {
    const sortedIncidents = [...incidents].sort((a, b) => new Date(b.date) - new Date(a.date));
    const lastIncident = sortedIncidents[0];
    document.getElementById('incidentDriverName').value = lastIncident.driverName;
    document.getElementById('incidentVehicleReg').value = lastIncident.vehicleReg;
  }
}

function applyGlobalFilter() {
  globalStartDate = document.getElementById('globalStartDate').value;
  globalEndDate = document.getElementById('globalEndDate').value;
  if (!globalStartDate && !globalEndDate) {
    showToast('‚ö†Ô∏è Please select at least one date', 'warning');
    return;
  }
  renderTrips();
  renderFuel();
  renderChecklists();
  renderIncidents();
  updateStatistics();
  showToast('‚úÖ Filter applied successfully');
}

function clearGlobalFilter() {
  globalStartDate = null;
  globalEndDate = null;
  document.getElementById('globalStartDate').value = '';
  document.getElementById('globalEndDate').value = '';
  renderTrips();
  renderFuel();
  renderChecklists();
  renderIncidents();
  updateStatistics();
  showToast('‚úÖ Filter cleared');
}

function isWithinGlobalDateRange(dateString) {
  if (!globalStartDate && !globalEndDate) return true;
  const itemDate = new Date(dateString);
  const start = globalStartDate ? new Date(globalStartDate) : null;
  const end = globalEndDate ? new Date(globalEndDate) : null;
  if (start && end) return itemDate >= start && itemDate <= end;
  else if (start) return itemDate >= start;
  else if (end) return itemDate <= end;
  return true;
}

function hasAnyActiveFilters() {
  const filters = {
    tripSearch: document.getElementById('searchInput').value.trim(),
    tripVehicle: document.getElementById('filterVehicle').value.trim(),
    tripDriver: document.getElementById('filterDriver').value.trim(),
    tripReference: document.getElementById('filterReference').value.trim(),
    fuelSearch: document.getElementById('fuelSearchInput').value.trim(),
    fuelVehicle: document.getElementById('fuelFilterVehicle').value.trim(),
    fuelDriver: document.getElementById('fuelFilterDriver').value.trim(),
    checklistSearch: document.getElementById('checklistSearchInput').value.trim(),
    checklistDriver: document.getElementById('checklistFilterDriver').value.trim(),
    checklistVehicle: document.getElementById('checklistFilterVehicle').value.trim(),
    incidentSearch: document.getElementById('incidentSearchInput').value.trim(),
    incidentDriver: document.getElementById('incidentFilterDriver').value.trim(),
    incidentVehicle: document.getElementById('incidentFilterVehicle').value.trim(),
    incidentType: document.getElementById('incidentFilterType').value
  };
  
  return globalStartDate || globalEndDate || 
    filters.tripSearch || filters.tripVehicle || filters.tripDriver || filters.tripReference ||
    filters.fuelSearch || filters.fuelVehicle || filters.fuelDriver ||
    filters.checklistSearch || filters.checklistDriver || filters.checklistVehicle ||
    filters.incidentSearch || filters.incidentDriver || filters.incidentVehicle || filters.incidentType;
}

function showConfirmDialog(action) {
  const messages = {
    'clearAllTrips': { title: '‚ö†Ô∏è Delete All Trips?', message: 'This will permanently delete ALL trips. This action cannot be undone!' },
    'clearAllFuel': { title: '‚ö†Ô∏è Delete All Fuel Entries?', message: 'This will permanently delete ALL fuel entries. This action cannot be undone!' },
    'clearAllChecklists': { title: '‚ö†Ô∏è Delete All Checklists?', message: 'This will permanently delete ALL checklists. This action cannot be undone!' },
    'clearAllIncidents': { title: '‚ö†Ô∏è Delete All Incidents?', message: 'This will permanently delete ALL incident reports. This action cannot be undone!' },
    'exportNoFilters': { title: 'üì• Filter Required for PDF Export', message: 'To protect your data, you must apply at least ONE filter before exporting.\n\nUse: Date Range, Vehicle Reg, Driver Name, Reference, Incident Type, or any Search box.' }
  };
  const config = messages[action];
  if (config) {
    document.getElementById('confirmTitle').textContent = config.title;
    document.getElementById('confirmMessage').textContent = config.message;
    pendingConfirmAction = action;
    
    if (action === 'exportNoFilters') {
      document.querySelector('.confirm-yes').textContent = 'OK';
      document.querySelector('.confirm-no').style.display = 'none';
    } else {
      document.querySelector('.confirm-yes').textContent = 'Yes, Delete';
      document.querySelector('.confirm-no').style.display = 'inline-block';
    }
    
    document.getElementById('confirmDialog').style.display = 'block';
  }
}

function closeConfirmDialog() {
  document.getElementById('confirmDialog').style.display = 'none';
  pendingConfirmAction = null;
}

function confirmAction() {
  if (pendingConfirmAction === 'clearAllTrips') {
    trips = [];
    saveTrips();
    renderTrips();
    updateStatistics();
    showToast('üóëÔ∏è All trips cleared');
  } else if (pendingConfirmAction === 'clearAllFuel') {
    fuelEntries = [];
    saveFuel();
    renderFuel();
    updateStatistics();
    showToast('üóëÔ∏è All fuel entries cleared');
  } else if (pendingConfirmAction === 'clearAllChecklists') {
    checklists = [];
    saveChecklists();
    renderChecklists();
    showToast('üóëÔ∏è All checklists cleared');
  } else if (pendingConfirmAction === 'clearAllIncidents') {
    incidents = [];
    saveIncidents();
    renderIncidents();
    showToast('üóëÔ∏è All incidents cleared');
  }
  closeConfirmDialog();
}

window.addEventListener('load', () => {
  renderTrips();
  renderFuel();
  renderServiceReminders();
  renderChecklists();
  renderIncidents();
  updateStatistics();
  checkServiceAlerts();
  autoFillTripForm();
  autoFillFuelForm();
  autoFillChecklistForm();
  autoFillIncidentForm();
});

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = 'toast';
  if (type === 'warning') toast.classList.add('warning');
  if (type === 'error') toast.classList.add('error');
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  const tabs = { 'trips': 0, 'fuel': 1, 'service': 2, 'checklist': 3, 'incidents': 4 };
  document.querySelectorAll('.tab-btn')[tabs[tab]].classList.add('active');
  document.getElementById(tab + 'Tab').classList.add('active');
  if (tab === 'trips') autoFillTripForm();
  if (tab === 'fuel') autoFillFuelForm();
  if (tab === 'checklist') autoFillChecklistForm();
  if (tab === 'incidents') autoFillIncidentForm();
}

function checkServiceAlerts() {
  const alertsDiv = document.getElementById('serviceAlerts');
  const alerts = [];
  serviceReminders.forEach(service => {
    const latestTrip = trips.filter(t => t.vehicleReg === service.vehicleReg).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
    const latestFuel = fuelEntries.filter(f => f.vehicleReg === service.vehicleReg).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
    let currentKm = service.currentServiceKm;
    if (latestTrip) currentKm = Math.max(currentKm, latestTrip.endKm);
    if (latestFuel) currentKm = Math.max(currentKm, latestFuel.kmReading);
    const kmRemaining = service.nextServiceKm - currentKm;
    if (kmRemaining <= 0) {
      alerts.push({ vehicle: service.vehicleReg, type: service.serviceType, kmRemaining, urgent: true });
    } else if (kmRemaining <= 500) {
      alerts.push({ vehicle: service.vehicleReg, type: service.serviceType, kmRemaining, urgent: false });
    }
  });
  if (alerts.length > 0) {
    alertsDiv.innerHTML = alerts.map(alert => `
      <div class="service-alert ${alert.urgent ? 'urgent' : ''}">
        <div class="icon">${alert.urgent ? '‚ö†Ô∏è' : '‚ö†Ô∏è'}</div>
        <div class="content">
          <div class="title">${alert.urgent ? 'SERVICE OVERDUE!' : 'Service Due Soon'}</div>
          <div>${alert.vehicle} - ${alert.type}</div>
          <div>${alert.kmRemaining <= 0 ? 'Overdue by ' + Math.abs(alert.kmRemaining).toFixed(0) + ' km' : alert.kmRemaining.toFixed(0) + ' km remaining'}</div>
        </div>
      </div>
    `).join('');
  } else {
    alertsDiv.innerHTML = '';
  }
}

document.getElementById('receiptImage').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(event) {
      currentReceiptImage = event.target.result;
      document.getElementById('imagePreview').src = currentReceiptImage;
      document.getElementById('imagePreview').style.display = 'block';
      document.getElementById('uploadText').style.display = 'none';
      document.getElementById('imageUploadArea').classList.add('has-image');
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById('tripImages').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  currentTripImages = [];
  const previewDiv = document.getElementById('tripImagesPreview');
  previewDiv.innerHTML = '';
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(event) {
      currentTripImages.push(event.target.result);
      const img = document.createElement('img');
      img.src = event.target.result;
      img.className = 'receipt-thumbnail';
      img.onclick = () => viewImage(event.target.result);
      previewDiv.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
  if (files.length > 0) {
    document.getElementById('tripUploadText').style.display = 'none';
  }
});

document.getElementById('incidentImages').addEventListener('change', function(e) {
  const files = Array.from(e.target.files);
  currentIncidentImages = [];
  const previewDiv = document.getElementById('incidentImagesPreview');
  previewDiv.innerHTML = '';
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(event) {
      currentIncidentImages.push(event.target.result);
      const img = document.createElement('img');
      img.src = event.target.result;
      img.className = 'receipt-thumbnail';
      img.onclick = () => viewImage(event.target.result);
      previewDiv.appendChild(img);
    };
    reader.readAsDataURL(file);
  });
  if (files.length > 0) {
    document.getElementById('incidentUploadText').style.display = 'none';
  }
});

function viewImage(imageSrc) {
  document.getElementById('modalImage').src = imageSrc;
  document.getElementById('imageModal').style.display = 'block';
}

function closeImageModal() {
  document.getElementById('imageModal').style.display = 'none';
}

window.onclick = function(event) {
  const modal = document.getElementById('imageModal');
  const confirmDialog = document.getElementById('confirmDialog');
  if (event.target == modal) modal.style.display = 'none';
  if (event.target == confirmDialog) closeConfirmDialog();
}

document.getElementById('tripForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const startKm = parseFloat(document.getElementById('startKm').value) || 0;
  const endKm = parseFloat(document.getElementById('endKm').value) || 0;
  if (endKm < startKm) {
    showToast('‚ö†Ô∏è End KM must be greater than Start KM!', 'warning');
    return;
  }
  const trip = {
    id: editingTripId || Date.now(),
    date: document.getElementById('tripDate').value,
    time: document.getElementById('tripTime').value,
    driverName: document.getElementById('driverName').value,
    vehicleReg: document.getElementById('vehicleReg').value.toUpperCase(),
    startLocation: document.getElementById('startLocation').value,
    endLocation: document.getElementById('endLocation').value,
    startKm: startKm,
    endKm: endKm,
    distance: endKm - startKm,
    reference: document.getElementById('reference').value,
    notes: document.getElementById('notes').value,
    images: currentTripImages,
    createdAt: editingTripId ? trips.find(t => t.id === editingTripId).createdAt : new Date().toISOString()
  };
  if (editingTripId) {
    const index = trips.findIndex(t => t.id === editingTripId);
    trips[index] = trip;
    editingTripId = null;
    document.getElementById('submitBtnText').textContent = 'Add Trip';
    document.getElementById('cancelBtn').style.display = 'none';
    showToast('‚úÖ Trip updated successfully!');
  } else {
    trips.unshift(trip);
    showToast('‚úÖ Trip saved successfully!');
  }
  saveTrips();
  renderTrips();
  updateStatistics();
  checkServiceAlerts();
  resetTripForm();
});

function resetTripForm() {
  document.getElementById('tripForm').reset();
  document.getElementById('tripDate').valueAsDate = new Date();
  currentTripImages = [];
  document.getElementById('tripImagesPreview').innerHTML = '';
  document.getElementById('tripUploadText').style.display = 'block';
  autoFillTripForm();
}

document.getElementById('fuelForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const fuelEntry = {
    id: editingFuelId || Date.now(),
    date: document.getElementById('fuelDate').value,
    time: document.getElementById('fuelTime').value,
    driverName: document.getElementById('fuelDriverName').value,
    vehicleReg: document.getElementById('fuelVehicleReg').value.toUpperCase(),
    kmReading: parseFloat(document.getElementById('fuelKmReading').value) || 0,
    liters: parseFloat(document.getElementById('fuelLiters').value) || 0,
    cost: parseFloat(document.getElementById('fuelCost').value) || 0,
    station: document.getElementById('fuelStation').value,
    notes: document.getElementById('fuelNotes').value,
    receiptImage: currentReceiptImage,
    createdAt: editingFuelId ? fuelEntries.find(f => f.id === editingFuelId).createdAt : new Date().toISOString()
  };
  if (editingFuelId) {
    const index = fuelEntries.findIndex(f => f.id === editingFuelId);
    fuelEntries[index] = fuelEntry;
    editingFuelId = null;
    document.getElementById('fuelSubmitBtnText').textContent = 'Add Fuel Entry';
    document.getElementById('fuelCancelBtn').style.display = 'none';
    showToast('‚úÖ Fuel entry updated successfully!');
  } else {
    fuelEntries.unshift(fuelEntry);
    showToast('‚úÖ Fuel entry saved successfully!');
  }
  saveFuel();
  renderFuel();
  updateStatistics();
  checkServiceAlerts();
  resetFuelForm();
});

document.getElementById('serviceForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const service = {
    id: editingServiceId || Date.now(),
    vehicleReg: document.getElementById('serviceVehicleReg').value.toUpperCase(),
    currentServiceKm: parseFloat(document.getElementById('currentServiceKm').value) || 0,
    nextServiceKm: parseFloat(document.getElementById('nextServiceKm').value) || 0,
    serviceType: document.getElementById('serviceType').value,
    notes: document.getElementById('serviceNotes').value,
    createdAt: editingServiceId ? serviceReminders.find(s => s.id === editingServiceId).createdAt : new Date().toISOString()
  };
  if (editingServiceId) {
    const index = serviceReminders.findIndex(s => s.id === editingServiceId);
    serviceReminders[index] = service;
    editingServiceId = null;
    document.getElementById('serviceSubmitBtnText').textContent = 'Set Reminder';
    document.getElementById('serviceCancelBtn').style.display = 'none';
    showToast('‚úÖ Service reminder updated successfully!');
  } else {
    serviceReminders.unshift(service);
    showToast('‚úÖ Service reminder set successfully!');
  }
  saveServiceReminders();
  renderServiceReminders();
  checkServiceAlerts();
  document.getElementById('serviceForm').reset();
});

document.getElementById('checklistForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const checklist = {
    id: editingChecklistId || Date.now(),
    date: document.getElementById('checklistDate').value,
    driverName: document.getElementById('checklistDriverName').value,
    vehicleReg: document.getElementById('checklistVehicleReg').value.toUpperCase(),
    kmReading: parseFloat(document.getElementById('checklistKmReading').value) || 0,
    items: {
      tires: document.getElementById('check_tires').checked,
      oil: document.getElementById('check_oil').checked,
      water: document.getElementById('check_water').checked,
      brakes: document.getElementById('check_brakes').checked,
      lights: document.getElementById('check_lights').checked,
      wipers: document.getElementById('check_wipers').checked,
      battery: document.getElementById('check_battery').checked,
      mirrors: document.getElementById('check_mirrors').checked,
      belts: document.getElementById('check_belts').checked,
      fuel: document.getElementById('check_fuel').checked
    },
    notes: document.getElementById('checklistNotes').value,
    createdAt: editingChecklistId ? checklists.find(c => c.id === editingChecklistId).createdAt : new Date().toISOString()
  };
  if (editingChecklistId) {
    const index = checklists.findIndex(c => c.id === editingChecklistId);
    checklists[index] = checklist;
    editingChecklistId = null;
    document.getElementById('checklistSubmitBtnText').textContent = 'Save Checklist';
    document.getElementById('checklistCancelBtn').style.display = 'none';
    showToast('‚úÖ Checklist updated successfully!');
  } else {
    checklists.unshift(checklist);
    showToast('‚úÖ Checklist saved successfully!');
  }
  saveChecklists();
  renderChecklists();
  document.getElementById('checklistForm').reset();
  document.getElementById('checklistDate').valueAsDate = new Date();
  document.querySelectorAll('#checklistForm input[type="checkbox"]').forEach(cb => cb.checked = true);
  autoFillChecklistForm();
});

document.getElementById('incidentForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const incident = {
    id: editingIncidentId || Date.now(),
    date: document.getElementById('incidentDate').value,
    time: document.getElementById('incidentTime').value,
    driverName: document.getElementById('incidentDriverName').value,
    vehicleReg: document.getElementById('incidentVehicleReg').value.toUpperCase(),
    location: document.getElementById('incidentLocation').value,
    type: document.getElementById('incidentType').value,
    description: document.getElementById('incidentDescription').value,
    images: currentIncidentImages,
    createdAt: editingIncidentId ? incidents.find(i => i.id === editingIncidentId).createdAt : new Date().toISOString()
  };
  if (editingIncidentId) {
    const index = incidents.findIndex(i => i.id === editingIncidentId);
    incidents[index] = incident;
    editingIncidentId = null;
    document.getElementById('incidentSubmitBtnText').textContent = 'Report Incident';
    document.getElementById('incidentCancelBtn').style.display = 'none';
    showToast('‚úÖ Incident report updated successfully!');
  } else {
    incidents.unshift(incident);
    showToast('‚úÖ Incident report saved successfully!');
  }
  saveIncidents();
  renderIncidents();
  resetIncidentForm();
});

function resetFuelForm() {
  document.getElementById('fuelForm').reset();
  document.getElementById('fuelDate').valueAsDate = new Date();
  currentReceiptImage = null;
  document.getElementById('imagePreview').style.display = 'none';
  document.getElementById('uploadText').style.display = 'block';
  document.getElementById('imageUploadArea').classList.remove('has-image');
  autoFillFuelForm();
}

function resetIncidentForm() {
  document.getElementById('incidentForm').reset();
  document.getElementById('incidentDate').valueAsDate = new Date();
  currentIncidentImages = [];
  document.getElementById('incidentImagesPreview').innerHTML = '';
  document.getElementById('incidentUploadText').style.display = 'block';
  autoFillIncidentForm();
}

document.getElementById('cancelBtn').addEventListener('click', () => {
  editingTripId = null;
  document.getElementById('submitBtnText').textContent = 'Add Trip';
  document.getElementById('cancelBtn').style.display = 'none';
  resetTripForm();
});

document.getElementById('fuelCancelBtn').addEventListener('click', () => {
  editingFuelId = null;
  document.getElementById('fuelSubmitBtnText').textContent = 'Add Fuel Entry';
  document.getElementById('fuelCancelBtn').style.display = 'none';
  resetFuelForm();
});

document.getElementById('serviceCancelBtn').addEventListener('click', () => {
  editingServiceId = null;
  document.getElementById('serviceSubmitBtnText').textContent = 'Set Reminder';
  document.getElementById('serviceCancelBtn').style.display = 'none';
  document.getElementById('serviceForm').reset();
});

document.getElementById('checklistCancelBtn').addEventListener('click', () => {
  editingChecklistId = null;
  document.getElementById('checklistSubmitBtnText').textContent = 'Save Checklist';
  document.getElementById('checklistCancelBtn').style.display = 'none';
  document.getElementById('checklistForm').reset();
  document.getElementById('checklistDate').valueAsDate = new Date();
  document.querySelectorAll('#checklistForm input[type="checkbox"]').forEach(cb => cb.checked = true);
  autoFillChecklistForm();
});

document.getElementById('incidentCancelBtn').addEventListener('click', () => {
  editingIncidentId = null;
  document.getElementById('incidentSubmitBtnText').textContent = 'Report Incident';
  document.getElementById('incidentCancelBtn').style.display = 'none';
  resetIncidentForm();
});

function saveTrips() { localStorage.setItem('driverTrips', JSON.stringify(trips)); }
function saveFuel() { localStorage.setItem('fuelEntries', JSON.stringify(fuelEntries)); }
function saveServiceReminders() { localStorage.setItem('serviceReminders', JSON.stringify(serviceReminders)); }
function saveChecklists() { localStorage.setItem('vehicleChecklists', JSON.stringify(checklists)); }
function saveIncidents() { localStorage.setItem('incidents', JSON.stringify(incidents)); }

function exportToPDF() {
  if (!hasAnyActiveFilters()) {
    showConfirmDialog('exportNoFilters');
    return;
  }
  
  const allFilters = {
    search: document.getElementById('searchInput').value.toLowerCase() || 
            document.getElementById('fuelSearchInput').value.toLowerCase() ||
            document.getElementById('checklistSearchInput').value.toLowerCase() ||
            document.getElementById('incidentSearchInput').value.toLowerCase(),
    vehicle: document.getElementById('filterVehicle').value.toLowerCase() || 
             document.getElementById('fuelFilterVehicle').value.toLowerCase() ||
             document.getElementById('checklistFilterVehicle').value.toLowerCase() ||
             document.getElementById('incidentFilterVehicle').value.toLowerCase(),
    driver: document.getElementById('filterDriver').value.toLowerCase() || 
            document.getElementById('fuelFilterDriver').value.toLowerCase() ||
            document.getElementById('checklistFilterDriver').value.toLowerCase() ||
            document.getElementById('incidentFilterDriver').value.toLowerCase(),
    reference: document.getElementById('filterReference').value.toLowerCase(),
    incidentType: document.getElementById('incidentFilterType').value
  };
  
  const filteredTrips = trips.filter(item => {
    const matchesSearch = !allFilters.search || item.startLocation.toLowerCase().includes(allFilters.search) || 
      item.endLocation.toLowerCase().includes(allFilters.search) || item.notes.toLowerCase().includes(allFilters.search) || 
      item.reference.toLowerCase().includes(allFilters.search) || item.driverName.toLowerCase().includes(allFilters.search) || 
      item.vehicleReg.toLowerCase().includes(allFilters.search);
    const matchesVehicle = !allFilters.vehicle || item.vehicleReg.toLowerCase().includes(allFilters.vehicle);
    const matchesDriver = !allFilters.driver || item.driverName.toLowerCase().includes(allFilters.driver);
    const matchesReference = !allFilters.reference || item.reference.toLowerCase().includes(allFilters.reference);
    const matchesDateRange = isWithinGlobalDateRange(item.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesReference && matchesDateRange;
  });
  
  const filteredFuel = fuelEntries.filter(item => {
    const matchesSearch = !allFilters.search || item.driverName.toLowerCase().includes(allFilters.search) || 
      item.vehicleReg.toLowerCase().includes(allFilters.search) || item.station.toLowerCase().includes(allFilters.search) || 
      item.notes.toLowerCase().includes(allFilters.search);
    const matchesVehicle = !allFilters.vehicle || item.vehicleReg.toLowerCase().includes(allFilters.vehicle);
    const matchesDriver = !allFilters.driver || item.driverName.toLowerCase().includes(allFilters.driver);
    const matchesDateRange = isWithinGlobalDateRange(item.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesDateRange;
  });
  
  const filteredChecklists = checklists.filter(item => {
    const matchesSearch = !allFilters.search || item.driverName.toLowerCase().includes(allFilters.search) || 
      item.vehicleReg.toLowerCase().includes(allFilters.search) || item.notes.toLowerCase().includes(allFilters.search);
    const matchesVehicle = !allFilters.vehicle || item.vehicleReg.toLowerCase().includes(allFilters.vehicle);
    const matchesDriver = !allFilters.driver || item.driverName.toLowerCase().includes(allFilters.driver);
    const matchesDateRange = isWithinGlobalDateRange(item.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesDateRange;
  });
  
  const filteredIncidents = incidents.filter(item => {
    const matchesSearch = !allFilters.search || item.driverName.toLowerCase().includes(allFilters.search) || 
      item.vehicleReg.toLowerCase().includes(allFilters.search) || item.location.toLowerCase().includes(allFilters.search) || 
      item.description.toLowerCase().includes(allFilters.search);
    const matchesVehicle = !allFilters.vehicle || item.vehicleReg.toLowerCase().includes(allFilters.vehicle);
    const matchesDriver = !allFilters.driver || item.driverName.toLowerCase().includes(allFilters.driver);
    const matchesType = !allFilters.incidentType || item.type === allFilters.incidentType;
    const matchesDateRange = isWithinGlobalDateRange(item.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesType && matchesDateRange;
  });
  
  if (filteredTrips.length === 0 && filteredFuel.length === 0 && filteredChecklists.length === 0 && filteredIncidents.length === 0) {
    showToast('‚ö†Ô∏è No data matches your filters!', 'warning');
    return;
  }
  
  const exportDiv = document.getElementById('pdfExportContent');
  let html = '<div class="pdf-page"><h1 class="pdf-title">üöö Vehicle Tracker Report - ' + new Date().toLocaleDateString() + '</h1>';
  
  if (filteredTrips.length > 0) {
    html += '<div class="pdf-section"><h2 class="pdf-section-title">üìã Trips (' + filteredTrips.length + ')</h2>';
    filteredTrips.forEach(trip => {
      html += '<div class="pdf-trip-detail">';
      html += `<div class="pdf-trip-header">${formatDate(trip.date)} ${trip.time ? '‚Ä¢ ' + trip.time : ''} - ${trip.vehicleReg}</div>`;
      html += '<div class="pdf-trip-info">';
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Driver:</span> ${escapeHtml(trip.driverName)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">From:</span> ${escapeHtml(trip.startLocation)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">To:</span> ${escapeHtml(trip.endLocation)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Distance:</span> ${trip.distance.toFixed(1)} km</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Start KM:</span> ${trip.startKm.toFixed(1)} km</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">End KM:</span> ${trip.endKm.toFixed(1)} km</div>`;
      if (trip.reference) html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Reference:</span> ${escapeHtml(trip.reference)}</div>`;
      if (trip.notes) html += `<div class="pdf-trip-info-item" style="grid-column: 1 / -1;"><span class="pdf-trip-info-label">Notes:</span> ${escapeHtml(trip.notes)}</div>`;
      html += '</div>';
      if (trip.images && trip.images.length > 0) {
        html += '<div style="margin-top: 15px;"><strong style="font-size: 12px; color: #333;">üì∑ Destination Photos:</strong></div><div class="pdf-gallery">';
        trip.images.forEach(img => { html += `<img src="${img}" alt="Trip Photo">`; });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }
  
  if (filteredFuel.length > 0) {
    html += '<div class="pdf-section"><h2 class="pdf-section-title">‚õΩFuel Entries (' + filteredFuel.length + ')</h2>';
    filteredFuel.forEach(fuel => {
      html += '<div class="pdf-trip-detail">';
      html += `<div class="pdf-trip-header" style="color: #28a745 !important;">${formatDate(fuel.date)} ${fuel.time ? '‚Ä¢ ' + fuel.time : ''} - ${fuel.vehicleReg}</div>`;
      html += '<div class="pdf-trip-info">';
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Driver:</span> ${escapeHtml(fuel.driverName)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">KM Reading:</span> ${fuel.kmReading.toFixed(1)} km</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Liters:</span> ${fuel.liters.toFixed(1)} L</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Cost:</span> R${fuel.cost.toFixed(2)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Price/L:</span> R${(fuel.cost / fuel.liters).toFixed(2)}</div>`;
      if (fuel.station) html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Station:</span> ${escapeHtml(fuel.station)}</div>`;
      if (fuel.notes) html += `<div class="pdf-trip-info-item" style="grid-column: 1 / -1;"><span class="pdf-trip-info-label">Notes:</span> ${escapeHtml(fuel.notes)}</div>`;
      html += '</div>';
      if (fuel.receiptImage) {
        html += '<div style="margin-top: 15px;"><strong style="font-size: 12px; color: #333;">üì∑ Receipt:</strong></div>';
        html += `<div style="margin-top: 10px;"><img src="${fuel.receiptImage}" style="max-width: 100%; max-height: 400px; border: 2px solid #ccc; border-radius: 6px;"></div>`;
      }
      html += '</div>';
    });
    html += '</div>';
  }
  
  if (filteredIncidents.length > 0) {
    html += '<div class="pdf-section"><h2 class="pdf-section-title">‚ö†Ô∏è Incidents (' + filteredIncidents.length + ')</h2>';
    filteredIncidents.forEach(i => {
      html += '<div class="pdf-trip-detail">';
      html += `<div class="pdf-trip-header" style="color: #dc3545 !important;">${formatDate(i.date)} ${i.time ? '‚Ä¢ ' + i.time : ''} - ${i.vehicleReg}</div>`;
      html += '<div class="pdf-trip-info">';
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Driver:</span> ${escapeHtml(i.driverName)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Location:</span> ${escapeHtml(i.location)}</div>`;
      html += `<div class="pdf-trip-info-item"><span class="pdf-trip-info-label">Type:</span> ${i.type}</div>`;
      html += `<div class="pdf-trip-info-item" style="grid-column: 1 / -1;"><span class="pdf-trip-info-label">Description:</span> ${escapeHtml(i.description)}</div>`;
      html += '</div>';
      if (i.images && i.images.length > 0) {
        html += '<div style="margin-top: 15px;"><strong style="font-size: 12px; color: #333;">üì∑ Damage Photos:</strong></div><div class="pdf-gallery">';
        i.images.forEach(img => { html += `<img src="${img}" alt="Incident Photo">`; });
        html += '</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }
  
  if (filteredChecklists.length > 0) {
    html += '<div class="pdf-section"><h2 class="pdf-section-title">‚úÖ Vehicle Checklists (' + filteredChecklists.length + ')</h2>';
    html += '<table class="pdf-table"><thead><tr>';
    html += '<th>Date</th><th>Driver</th><th>Vehicle</th><th>KM</th><th>Tires</th><th>Oil</th><th>Water</th><th>Brakes</th><th>Lights</th><th>Wipers</th><th>Battery</th><th>Mirrors</th><th>Belts</th><th>Fuel</th><th>Notes</th>';
    html += '</tr></thead><tbody>';
    filteredChecklists.forEach(c => {
      html += '<tr>';
      html += `<td>${c.date}</td><td>${escapeHtml(c.driverName)}</td><td>${c.vehicleReg}</td><td>${c.kmReading.toFixed(1)}</td>`;
      html += `<td>${c.items.tires ? '‚úì' : '‚úó'}</td><td>${c.items.oil ? '‚úì' : '‚úó'}</td><td>${c.items.water ? '‚úì' : '‚úó'}</td><td>${c.items.brakes ? '‚úì' : '‚úó'}</td>`;
      html += `<td>${c.items.lights ? '‚úì' : '‚úó'}</td><td>${c.items.wipers ? '‚úì' : '‚úó'}</td><td>${c.items.battery ? '‚úì' : '‚úó'}</td><td>${c.items.mirrors ? '‚úì' : '‚úó'}</td>`;
      html += `<td>${c.items.belts ? '‚úì' : '‚úó'}</td><td>${c.items.fuel ? '‚úì' : '‚úó'}</td><td>${escapeHtml(c.notes)}</td>`;
      html += '</tr>';
    });
    html += '</tbody></table></div>';
  }
  
  html += '</div>';
  exportDiv.innerHTML = html;
  setTimeout(() => window.print(), 100);
  const totalRecords = filteredTrips.length + filteredFuel.length + filteredChecklists.length + filteredIncidents.length;
  showToast('üì• PDF ready: ' + totalRecords + ' records');
}

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function renderTrips() {
  const tripsList = document.getElementById('tripsList');
  const searchTerm = document.getElementById('searchInput').value.toLowerCase();
  const filterVehicle = document.getElementById('filterVehicle').value.toLowerCase();
  const filterDriver = document.getElementById('filterDriver').value.toLowerCase();
  const filterReference = document.getElementById('filterReference').value.toLowerCase();
  
  let filteredTrips = trips.filter(trip => {
    const matchesSearch = trip.startLocation.toLowerCase().includes(searchTerm) || trip.endLocation.toLowerCase().includes(searchTerm) ||
      trip.notes.toLowerCase().includes(searchTerm) || trip.reference.toLowerCase().includes(searchTerm) ||
      trip.driverName.toLowerCase().includes(searchTerm) || trip.vehicleReg.toLowerCase().includes(searchTerm);
    const matchesVehicle = !filterVehicle || trip.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDriver = !filterDriver || trip.driverName.toLowerCase().includes(filterDriver);
    const matchesReference = !filterReference || trip.reference.toLowerCase().includes(filterReference);
    const matchesDateRange = isWithinGlobalDateRange(trip.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesReference && matchesDateRange;
  });
  
  if (filteredTrips.length === 0) {
    tripsList.innerHTML = `<div class="no-trips"><div class="icon">üì≠</div><h3>No trips found</h3><p>Try adjusting your filters or add your first trip!</p></div>`;
    return;
  }
  
  tripsList.innerHTML = filteredTrips.map(trip => `
    <div class="trip-item">
      <div class="trip-header">
        <div class="trip-date">    <img src="https://i2.wp.com/cdn0.iconfinder.com/data/icons/small-n-flat/24/678120-calendar-clock-512.png" 
     alt="Car Icon" 
     width="30"> ${formatDate(trip.date)} ${trip.time ? '‚Ä¢ ' + trip.time : ''}</div>
        <div class="trip-actions">
          <button class="btn btn-small btn-edit" onclick="editTrip(${trip.id})">‚úèÔ∏è Edit</button>
          <button class="btn btn-small btn-delete" onclick="deleteTrip(${trip.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail"><div class="icon">üë§</div><div class="content"><div class="label">Driver</div><div class="value">${trip.driverName}</div></div></div>
        <div class="trip-detail"><div class="icon">üöó</div><div class="content"><div class="label">Vehicle</div><div class="value">${trip.vehicleReg}</div></div></div>
        <div class="trip-detail"><div class="icon">üìç</div><div class="content"><div class="label">From</div><div class="value">${trip.startLocation}</div></div></div>
        <div class="trip-detail"><div class="icon">üéØ</div><div class="content"><div class="label">To</div><div class="value">${trip.endLocation}</div></div></div>
        <div class="trip-detail"><div class="icon">üèÅ</div><div class="content"><div class="label">Start KM</div><div class="value">${trip.startKm.toFixed(1)} km</div></div></div>
        <div class="trip-detail"><div class="icon">üèÅ</div><div class="content"><div class="label">End KM</div><div class="value">${trip.endKm.toFixed(1)} km</div></div></div>
        ${trip.reference ? `<div class="trip-detail"><div class="icon">üìã</div><div class="content"><div class="label">Reference</div><div class="value">${trip.reference}</div></div></div>` : ''}
      </div>
      <div class="distance-badge">üõ£Ô∏è Distance Travelled: ${trip.distance.toFixed(1)} km</div>
      ${trip.images && trip.images.length > 0 ? `<div style="margin-top: 15px;"><strong style="color: white;">üì∑ Destination Photos (${trip.images.length}):</strong><div class="images-grid">${trip.images.map(img => `<img src="${img}" class="receipt-thumbnail" onclick="viewImage('${img}')" alt="Destination">`).join('')}</div></div>` : ''}
      ${trip.notes ? `<div class="trip-notes">üìù ${trip.notes}</div>` : ''}
    </div>
  `).join('');
}

function renderFuel() {
  const fuelList = document.getElementById('fuelList');
  const searchTerm = document.getElementById('fuelSearchInput').value.toLowerCase();
  const filterVehicle = document.getElementById('fuelFilterVehicle').value.toLowerCase();
  const filterDriver = document.getElementById('fuelFilterDriver').value.toLowerCase();
  
  let filteredFuel = fuelEntries.filter(fuel => {
    const matchesSearch = fuel.driverName.toLowerCase().includes(searchTerm) || fuel.vehicleReg.toLowerCase().includes(searchTerm) ||
      fuel.station.toLowerCase().includes(searchTerm) || fuel.notes.toLowerCase().includes(searchTerm);
    const matchesVehicle = !filterVehicle || fuel.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDriver = !filterDriver || fuel.driverName.toLowerCase().includes(filterDriver);
    const matchesDateRange = isWithinGlobalDateRange(fuel.date);
    return matchesSearch && matchesVehicle && matchesDriver && matchesDateRange;
  });
  
  if (filteredFuel.length === 0) {
    fuelList.innerHTML = `<div class="no-trips"><div class="icon">‚õΩ</div><h3>No fuel entries found</h3><p>Try adjusting your filters or add your first fuel entry!</p></div>`;
    return;
  }
  
  fuelList.innerHTML = filteredFuel.map(fuel => `
    <div class="fuel-item">
      <div class="trip-header">
        <div class="fuel-date">‚õΩ ${formatDate(fuel.date)} ${fuel.time ? '‚Ä¢ ' + fuel.time : ''}</div>
        <div class="trip-actions">
          <button class="btn btn-small btn-edit" onclick="editFuel(${fuel.id})">‚úèÔ∏è Edit</button>
          <button class="btn btn-small btn-delete" onclick="deleteFuel(${fuel.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail"><div class="icon">üë§</div><div class="content"><div class="label">Driver</div><div class="value">${fuel.driverName}</div></div></div>
        <div class="trip-detail"><div class="icon">üöó</div><div class="content"><div class="label">Vehicle</div><div class="value">${fuel.vehicleReg}</div></div></div>
        <div class="trip-detail"><div class="icon">üèÅ</div><div class="content"><div class="label">KM Reading</div><div class="value">${fuel.kmReading.toFixed(1)} km</div></div></div>
        <div class="trip-detail"><div class="icon">‚õΩ</div><div class="content"><div class="label">Fuel Amount</div><div class="value">${fuel.liters.toFixed(1)} L</div></div></div>
        <div class="trip-detail"><div class="icon">üí∞</div><div class="content"><div class="label">Cost</div><div class="value">R${fuel.cost.toFixed(2)}</div></div></div>
        <div class="trip-detail"><div class="icon">üî¢</div><div class="content"><div class="label">Price per Liter</div><div class="value">R${(fuel.cost / fuel.liters).toFixed(2)}/L</div></div></div>
        ${fuel.station ? `<div class="trip-detail"><div class="icon">üè™</div><div class="content"><div class="label">Station</div><div class="value">${fuel.station}</div></div></div>` : ''}
      </div>
      ${fuel.receiptImage ? `<div style="margin-top: 15px;"><strong style="color: white;">üì∑ Receipt:</strong><br><img src="${fuel.receiptImage}" class="receipt-thumbnail" onclick="viewImage('${fuel.receiptImage}')" alt="Receipt"></div>` : ''}
      ${fuel.notes ? `<div class="trip-notes">üìù ${fuel.notes}</div>` : ''}
    </div>
  `).join('');
}

function renderServiceReminders() {
  const serviceList = document.getElementById('serviceList');
  if (serviceReminders.length === 0) {
    serviceList.innerHTML = `<div class="no-trips"><div class="icon">üîß</div><h3>No service reminders</h3><p>Set your first service reminder above!</p></div>`;
    return;
  }
  serviceList.innerHTML = serviceReminders.map(service => {
    const latestTrip = trips.filter(t => t.vehicleReg === service.vehicleReg).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
    const latestFuel = fuelEntries.filter(f => f.vehicleReg === service.vehicleReg).sort((a,b) => new Date(b.date) - new Date(a.date))[0];
    let currentKm = service.currentServiceKm;
    if (latestTrip) currentKm = Math.max(currentKm, latestTrip.endKm);
    if (latestFuel) currentKm = Math.max(currentKm, latestFuel.kmReading);
    const kmRemaining = service.nextServiceKm - currentKm;
    const isOverdue = kmRemaining <= 0;
    const isDueSoon = kmRemaining > 0 && kmRemaining <= 500;
    return `
    <div class="service-item">
      <div class="trip-header">
        <div class="service-date">üîß ${service.serviceType}</div>
        <div class="trip-actions">
          <button class="btn btn-small btn-edit" onclick="editService(${service.id})">‚úèÔ∏è Edit</button>
          <button class="btn btn-small btn-delete" onclick="deleteService(${service.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail"><div class="icon">üöó</div><div class="content"><div class="label">Vehicle</div><div class="value">${service.vehicleReg}</div></div></div>
        <div class="trip-detail"><div class="icon">üìä</div><div class="content"><div class="label">Current KM</div><div class="value">${currentKm.toFixed(1)} km</div></div></div>
        <div class="trip-detail"><div class="icon">üéØ</div><div class="content"><div class="label">Service Due At</div><div class="value">${service.nextServiceKm.toFixed(1)} km</div></div></div>
        <div class="trip-detail"><div class="icon">${isOverdue ? 'üö®' : isDueSoon ? '‚ö†Ô∏è' : '‚úÖ'}</div><div class="content"><div class="label">Status</div><div class="value" style="color: ${isOverdue ? '#fca5a5' : isDueSoon ? '#fde047' : '#86efac'}">${isOverdue ? 'OVERDUE by ' + Math.abs(kmRemaining).toFixed(0) + ' km!' : isDueSoon ? kmRemaining.toFixed(0) + ' km remaining' : kmRemaining.toFixed(0) + ' km remaining'}</div></div></div>
      </div>
      ${service.notes ? `<div class="trip-notes">üìù ${service.notes}</div>` : ''}
    </div>
  `}).join('');
}

function renderChecklists() {
  const checklistList = document.getElementById('checklistList');
  const searchTerm = document.getElementById('checklistSearchInput').value.toLowerCase();
  const filterDriver = document.getElementById('checklistFilterDriver').value.toLowerCase();
  const filterVehicle = document.getElementById('checklistFilterVehicle').value.toLowerCase();
  
  let filteredChecklists = checklists.filter(checklist => {
    const matchesSearch = checklist.driverName.toLowerCase().includes(searchTerm) || checklist.vehicleReg.toLowerCase().includes(searchTerm) || checklist.notes.toLowerCase().includes(searchTerm);
    const matchesDriver = !filterDriver || checklist.driverName.toLowerCase().includes(filterDriver);
    const matchesVehicle = !filterVehicle || checklist.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDateRange = isWithinGlobalDateRange(checklist.date);
    return matchesSearch && matchesDriver && matchesVehicle && matchesDateRange;
  });
  
  if (filteredChecklists.length === 0) {
    checklistList.innerHTML = `<div class="no-trips"><div class="icon">‚úÖ</div><h3>No checklists found</h3><p>Try adjusting your filters!</p></div>`;
    return;
  }
  
  checklistList.innerHTML = filteredChecklists.map(checklist => {
    const totalItems = Object.keys(checklist.items).length;
    const passedItems = Object.values(checklist.items).filter(v => v).length;
    const allPassed = passedItems === totalItems;
    return `
    <div class="checklist-item">
      <div class="trip-header">
        <div class="checklist-date">‚úÖ ${formatDate(checklist.date)}</div>
        <div class="trip-actions">
          <span class="status-badge ${allPassed ? 'status-ok' : 'status-issue'}">${allPassed ? '‚úì All OK' : '‚ö†Ô∏è Issues Found'}</span>
          <button class="btn btn-small btn-delete" onclick="deleteChecklist(${checklist.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail"><div class="icon">üë§</div><div class="content"><div class="label">Driver</div><div class="value">${checklist.driverName}</div></div></div>
        <div class="trip-detail"><div class="icon">üöó</div><div class="content"><div class="label">Vehicle</div><div class="value">${checklist.vehicleReg}</div></div></div>
        <div class="trip-detail"><div class="icon">üèÅ</div><div class="content"><div class="label">KM Reading</div><div class="value">${checklist.kmReading.toFixed(1)} km</div></div></div>
        <div class="trip-detail"><div class="icon">üìä</div><div class="content"><div class="label">Score</div><div class="value">${passedItems}/${totalItems} Passed</div></div></div>
      </div>
      <div style="margin-top: 15px;"><strong style="color: white;">Checklist Results:</strong>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; color: white;">
          <div>${checklist.items.tires ? '‚úÖ' : '‚ùå'} Tires</div><div>${checklist.items.oil ? '‚úÖ' : '‚ùå'} Engine Oil</div>
          <div>${checklist.items.water ? '‚úÖ' : '‚ùå'} Coolant/Water</div><div>${checklist.items.brakes ? '‚úÖ' : '‚ùå'} Brakes</div>
          <div>${checklist.items.lights ? '‚úÖ' : '‚ùå'} Lights</div><div>${checklist.items.wipers ? '‚úÖ' : '‚ùå'} Wipers</div>
          <div>${checklist.items.battery ? '‚úÖ' : '‚ùå'} Battery</div><div>${checklist.items.mirrors ? '‚úÖ' : '‚ùå'} Mirrors</div>
          <div>${checklist.items.belts ? '‚úÖ' : '‚ùå'} Drive Belts</div><div>${checklist.items.fuel ? '‚úÖ' : '‚ùå'} Fuel Level</div>
        </div>
      </div>
      ${checklist.notes ? `<div class="trip-notes">üìù ${checklist.notes}</div>` : ''}
    </div>
  `}).join('');
}

function renderIncidents() {
  const incidentList = document.getElementById('incidentList');
  const searchTerm = document.getElementById('incidentSearchInput').value.toLowerCase();
  const filterType = document.getElementById('incidentFilterType').value;
  const filterDriver = document.getElementById('incidentFilterDriver').value.toLowerCase();
  const filterVehicle = document.getElementById('incidentFilterVehicle').value.toLowerCase();
  
  let filteredIncidents = incidents.filter(incident => {
    const matchesSearch = incident.driverName.toLowerCase().includes(searchTerm) || incident.vehicleReg.toLowerCase().includes(searchTerm) ||
      incident.location.toLowerCase().includes(searchTerm) || incident.description.toLowerCase().includes(searchTerm);
    const matchesType = !filterType || incident.type === filterType;
    const matchesDriver = !filterDriver || incident.driverName.toLowerCase().includes(filterDriver);
    const matchesVehicle = !filterVehicle || incident.vehicleReg.toLowerCase().includes(filterVehicle);
    const matchesDateRange = isWithinGlobalDateRange(incident.date);
    return matchesSearch && matchesType && matchesDriver && matchesVehicle && matchesDateRange;
  });
  
  if (filteredIncidents.length === 0) {
    incidentList.innerHTML = `<div class="no-trips"><div class="icon">‚ö†Ô∏è</div><h3>No incidents found</h3><p>Try adjusting your filters!</p></div>`;
    return;
  }
  
  incidentList.innerHTML = filteredIncidents.map(incident => `
    <div class="incident-item">
      <div class="trip-header">
        <div class="incident-date">‚ö†Ô∏è ${formatDate(incident.date)} ${incident.time ? '‚Ä¢ ' + incident.time : ''}</div>
        <div class="trip-actions">
          <button class="btn btn-small btn-delete" onclick="deleteIncident(${incident.id})">üóëÔ∏è Delete</button>
        </div>
      </div>
      <div class="trip-details">
        <div class="trip-detail"><div class="icon">üë§</div><div class="content"><div class="label">Driver</div><div class="value">${incident.driverName}</div></div></div>
        <div class="trip-detail"><div class="icon">üöó</div><div class="content"><div class="label">Vehicle</div><div class="value">${incident.vehicleReg}</div></div></div>
        <div class="trip-detail"><div class="icon">üìç</div><div class="content"><div class="label">Location</div><div class="value">${incident.location}</div></div></div>
        <div class="trip-detail"><div class="icon">‚ö†Ô∏è</div><div class="content"><div class="label">Type</div><div class="value">${incident.type}</div></div></div>
      </div>
      <div class="trip-notes">${incident.description}</div>
      ${incident.images && incident.images.length > 0 ? `<div style="margin-top: 15px;"><strong style="color: white;">üì∑ Photos (${incident.images.length}):</strong><div class="images-grid">${incident.images.map(img => `<img src="${img}" class="receipt-thumbnail" onclick="viewImage('${img}')" alt="Incident">`).join('')}</div></div>` : ''}
    </div>
  `).join('');
}

function editTrip(id) {
  const trip = trips.find(t => t.id === id);
  if (!trip) return;
  editingTripId = id;
  document.getElementById('tripDate').value = trip.date;
  document.getElementById('tripTime').value = trip.time;
  document.getElementById('driverName').value = trip.driverName;
  document.getElementById('vehicleReg').value = trip.vehicleReg;
  document.getElementById('startLocation').value = trip.startLocation;
  document.getElementById('endLocation').value = trip.endLocation;
  document.getElementById('startKm').value = trip.startKm;
  document.getElementById('endKm').value = trip.endKm;
  document.getElementById('reference').value = trip.reference;
  document.getElementById('notes').value = trip.notes;
  if (trip.images && trip.images.length > 0) {
    currentTripImages = trip.images;
    const previewDiv = document.getElementById('tripImagesPreview');
    previewDiv.innerHTML = '';
    trip.images.forEach(img => {
      const imgEl = document.createElement('img');
      imgEl.src = img;
      imgEl.className = 'receipt-thumbnail';
      imgEl.onclick = () => viewImage(img);
      previewDiv.appendChild(imgEl);
    });
    document.getElementById('tripUploadText').style.display = 'none';
  }
  document.getElementById('submitBtnText').textContent = 'Update Trip';
  document.getElementById('cancelBtn').style.display = 'inline-block';
  switchTab('trips');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function editFuel(id) {
  const fuel = fuelEntries.find(f => f.id === id);
  if (!fuel) return;
  editingFuelId = id;
  document.getElementById('fuelDate').value = fuel.date;
  document.getElementById('fuelTime').value = fuel.time;
  document.getElementById('fuelDriverName').value = fuel.driverName;
  document.getElementById('fuelVehicleReg').value = fuel.vehicleReg;
  document.getElementById('fuelKmReading').value = fuel.kmReading;
  document.getElementById('fuelLiters').value = fuel.liters;
  document.getElementById('fuelCost').value = fuel.cost;
  document.getElementById('fuelStation').value = fuel.station;
  document.getElementById('fuelNotes').value = fuel.notes;
  if (fuel.receiptImage) {
    currentReceiptImage = fuel.receiptImage;
    document.getElementById('imagePreview').src = fuel.receiptImage;
    document.getElementById('imagePreview').style.display = 'block';
    document.getElementById('uploadText').style.display = 'none';
    document.getElementById('imageUploadArea').classList.add('has-image');
  }
  document.getElementById('fuelSubmitBtnText').textContent = 'Update Fuel Entry';
  document.getElementById('fuelCancelBtn').style.display = 'inline-block';
  switchTab('fuel');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function editService(id) {
  const service = serviceReminders.find(s => s.id === id);
  if (!service) return;
  editingServiceId = id;
  document.getElementById('serviceVehicleReg').value = service.vehicleReg;
  document.getElementById('currentServiceKm').value = service.currentServiceKm;
  document.getElementById('nextServiceKm').value = service.nextServiceKm;
  document.getElementById('serviceType').value = service.serviceType;
  document.getElementById('serviceNotes').value = service.notes;
  document.getElementById('serviceSubmitBtnText').textContent = 'Update Reminder';
  document.getElementById('serviceCancelBtn').style.display = 'inline-block';
  switchTab('service');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function deleteTrip(id) {
  trips = trips.filter(t => t.id !== id);
  saveTrips();
  renderTrips();
  updateStatistics();
  checkServiceAlerts();
  showToast('üóëÔ∏è Trip deleted');
}

function deleteFuel(id) {
  fuelEntries = fuelEntries.filter(f => f.id !== id);
  saveFuel();
  renderFuel();
  updateStatistics();
  checkServiceAlerts();
  showToast('üóëÔ∏è Fuel entry deleted');
}

function deleteService(id) {
  serviceReminders = serviceReminders.filter(s => s.id !== id);
  saveServiceReminders();
  renderServiceReminders();
  checkServiceAlerts();
  showToast('üóëÔ∏è Service reminder deleted');
}

function deleteChecklist(id) {
  checklists = checklists.filter(c => c.id !== id);
  saveChecklists();
  renderChecklists();
  showToast('üóëÔ∏è Checklist deleted');
}

function deleteIncident(id) {
  incidents = incidents.filter(i => i.id !== id);
  saveIncidents();
  renderIncidents();
  showToast('üóëÔ∏è Incident report deleted');
}

function updateStatistics() {
  const filteredTrips = trips.filter(t => isWithinGlobalDateRange(t.date));
  const filteredFuel = fuelEntries.filter(f => isWithinGlobalDateRange(f.date));
  const totalTrips = filteredTrips.length;
  const totalDistance = filteredTrips.reduce((sum, trip) => sum + trip.distance, 0);
  const totalFuelLiters = filteredFuel.reduce((sum, fuel) => sum + fuel.liters, 0);
  const totalFuelCost = filteredFuel.reduce((sum, fuel) => sum + fuel.cost, 0);
  document.getElementById('totalTrips').textContent = totalTrips;
  document.getElementById('totalDistance').textContent = totalDistance.toFixed(1) + ' km';
  document.getElementById('totalFuelLiters').textContent = totalFuelLiters.toFixed(1) + ' L';
  document.getElementById('totalFuelCost').textContent = 'R' + totalFuelCost.toFixed(2);
}

function formatDate(dateString) {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
}

document.getElementById('searchInput').addEventListener('input', renderTrips);
document.getElementById('filterVehicle').addEventListener('input', renderTrips);
document.getElementById('filterDriver').addEventListener('input', renderTrips);
document.getElementById('filterReference').addEventListener('input', renderTrips);
document.getElementById('fuelSearchInput').addEventListener('input', renderFuel);
document.getElementById('fuelFilterVehicle').addEventListener('input', renderFuel);
document.getElementById('fuelFilterDriver').addEventListener('input', renderFuel);
document.getElementById('checklistSearchInput').addEventListener('input', renderChecklists);
document.getElementById('checklistFilterDriver').addEventListener('input', renderChecklists);
document.getElementById('checklistFilterVehicle').addEventListener('input', renderChecklists);
document.getElementById('incidentSearchInput').addEventListener('input', renderIncidents);
document.getElementById('incidentFilterDriver').addEventListener('input', renderIncidents);
document.getElementById('incidentFilterVehicle').addEventListener('input', renderIncidents);
document.getElementById('incidentFilterType').addEventListener('change', renderIncidents);
</script>

</body>
</html>